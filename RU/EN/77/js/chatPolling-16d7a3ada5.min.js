function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var chlenruslana=1;define(["dom","ajax","analitics"],(function(t,e,n){var o=App.context.chatSalt,i=App.context.chatUrl,r=(function(){function r(){_classCallCheck(this,r),this.autoClose=4e4,this.time=0,this.connId=this.connId||Math.random().toString(36).substring(2,8),this.start()}return r.prototype.start=function(){var t=this,e=this;if(!App.context.dev&&i&&o&&App.context.userId){var r=new XMLHttpRequest;r.startTime=(new Date).getTime(),r.open("GET",i+"?key="+encodeURIComponent(o)+"&connectionId="+encodeURIComponent(e.connId)+"&userId="+encodeURIComponent(App.context.userId)),r.onerror=this.error.bind(this),r.onreadystatechange=function(){if(4===r.readyState){var e=r.status;if(200===e||0===e&&r.responseText.length){if(clearTimeout(t.timeout),clearTimeout(t.abortTimeout),t.abortTimeout=null,t.timeout=null,r&&r.responseText){var o;try{if(o=JSON.parse(r.responseText),o&&o.dublicate)return n.trackEvent({url:i,type:"Errors",status:"dublicate"}),t.connId=Math.random().toString(36).substring(2,8),t.start()}catch(a){return console.log(a),t.error()}return t.start(),void t.prepareData(o)}t.time=0,t.start()}else t.error()}},this.abortTimeout||(this.abortTimeout=setTimeout((function(){r&&r.abort&&(e.time=0,e.abortTimeout=null,r.abort(),n.trackEvent({url:i,type:"Errors",status:"abort"}),console.log("abort"))}),this.autoClose)),r.send(null)}},r.prototype.error=function(){clearTimeout(this.timeout),clearTimeout(this.abortTimeout),this.abortTimeout=null,this.timeout=null,this.timeout||(this.timeout=setTimeout(this.start.bind(this),this.time),this.time+=1e3)},r.prototype.prepareData=function(e){var n=this;t.isArray(e)?e.forEach((function(t){n.parseResponce(t)})):this.parseResponce(e)},r.prototype.parseResponce=function(t){require(["location","MessagesThreadAction","MessagesIndexAction","notify"],(function(e,o,i,r){n.track("message","receive",t.type);var a=e.getUrl();if(o.init(!0),parseInt(t.type,10)){if(a.indexOf(t.s)>=0&&a.indexOf("thread")>=0){o.renderMessage(t);var s=document.querySelector(".prof-meta.last-online");s&&s.parentNode.removeChild(s)}else a.indexOf("messages")>=0&&(t.unread=0,t.o=!0,i.createContact(t));a.indexOf("messages")<0&&a.indexOf("thread")<0&&!App.context.notification_disabled&&r.show(t)}else"typing"===t.type&&a.indexOf("thread")>=0?o.onTyping(t):"visitor"===t.type||"like"===t.type||"mutuals"===t.type?location.href.indexOf("profile/activity")>=0&&require(["ProfileActivityIndexAction"],(function(e){e.addNewUser(t,t.type)})):"was_read"===t.type&&(a.indexOf(t.s)>=0&&a.indexOf("thread")>=0?o.updateChatStatus("read"):a.indexOf("thread")<0&&a.indexOf("message")<0&&App.context.isUserVip&&!App.context.notification_disabled&&(t.m=App.context.translates.WasReadMessage,r.show(t)))}))},r.send=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.post(i+"/publish",t)},r})();return r}));
//# sourceMappingURL=chatPolling-16d7a3ada5.min.js.map
